# OKX 量化交易接入 / SDK 生产级验收清单（可对照核查）

> 目的：把“生产级”定义为**可验收的硬指标**，用于研发自查与审计复核。  
> 适用：OKX V5（REST + WebSocket），Golang 交易系统/SDK 接入层。

---

## 0. 审计目标（必填）

- 交易品类：`SPOT / MARGIN / SWAP / FUTURES / OPTION / RFQ / GRID / ...`
- 必须覆盖的 REST（列出 endpoint/Service）：`...`
- 必须覆盖的 WS（列出频道 + instType/instId 范围）：`...`
- 交易模式：`maker / taker / 混合 / 做市 / 趋势 / ...`
- 频率目标：
  - REST：`QPS` / 并发：`N` / P99 延迟：`ms`
  - WS：每秒消息量：`msg/s` / 可接受堆积时长：`s`
- 资金风险边界：最大单笔下单金额/数量、最大净敞口、最大杠杆：`...`

**验收要求**：未填写“审计目标”的验收结果视为无效（无法证明覆盖面）。

---

## 1. 构建与 CI（上线门槛）

- [ ] `go test ./v5/...` 全通过（证据：CI 记录/日志）
- [ ] `go test -race ./v5/...` 全通过（证据：CI 记录/日志）
- [ ] 静态检查（至少 `go vet`）无高危问题（证据：CI 记录/日志）
- [ ] 依赖可复现：Go 版本与依赖锁定（证据：版本号、构建产物可追溯 commit）

**失败即阻断上线**：是（属于基础门槛）。

---

## 2. 凭证与安全（资金红线）

- [ ] `APIKey/SecretKey/Passphrase` 永不落日志（含示例、debug、panic stack、HTTP header）
- [ ] 返回数据中包含敏感字段（如 `secretKey/passphrase`）时，默认不打印、不透传到不可信链路
- [ ] 敏感标识默认脱敏：`apiKey`、账户/子账户标识、IP 白名单、订单号（按统一规则）
- [ ] 生产 APIKey 最小权限原则：只读/交易/提现等严格隔离（证据：权限配置与流程）
- [ ] 生产强制 IP 白名单（证据：配置与变更审计）
- [ ] 配置来源合规：仅 env/secret manager 注入；仓库、镜像、CI 日志无明文凭证（证据：扫描结果）

**失败即阻断上线**：是（任何一条不满足均视为高危）。

---

## 3. REST 客户端健壮性（不确定性收敛）

- [ ] 默认超时：ctx 未设置 deadline 时也有安全默认超时（Fail-Fast）
- [ ] 错误语义正确：HTTP 200 但 `code != "0"` 必须视为失败；错误包含 `method/path/http/code/msg/request-id`
- [ ] 重试纪律：只对幂等请求自动重试；非幂等交易请求默认不重试
- [ ] 限频识别：HTTP 429 与 OKX 限频业务码（如 50011/50061）被准确分类
- [ ] 退避策略：指数退避 + 抖动（避免“429 风暴”）；允许全局配置最大退避
- [ ] 时间偏差治理：启动/定期 `SyncTime`；识别时间戳错误并触发自愈（重新 sync）
- [ ] 解析鲁棒性：字段新增/缺失不崩；少量非标准 envelope 有清晰兼容策略

**验收证据建议**：
- 压测/回放：模拟 429、5xx、网络抖动、时钟偏差，观察重试/退避/错误分类与恢复。

---

## 4. WS 客户端可靠性（不断流 + 可观测）

- [ ] 连接生命周期：断线自动重连；重连退避带抖动；可停止且能及时退出
- [ ] 订阅可验证：订阅/取消订阅可等待成功/失败事件；失败不可静默
- [ ] 重订阅可靠：重连后自动重订阅失败必须可见（错误回调/告警），且有补救策略（重连/降级/停止）
- [ ] handler 隔离：默认不在 read goroutine 执行重逻辑；明确背压策略（关键事件不丢或丢前强告警）
- [ ] 心跳策略：符合 OKX ping/pong 约束；pong 超时可检测并触发重连
- [ ] 深度一致性：books* 必须具备 seq/prev/checksum/断档检测；断档后可 reset 重建
- [ ] 并发边界清晰：对外暴露的 store/snapshot/readiness 语义明确（并发安全或强制单线程）

**验收证据建议**：
- 断网/抖动演练：验证重连、重订阅与数据恢复；
- 深度断档演练：验证断档检测与重建路径；
- handler 堆积演练：验证背压策略符合预期（不静默丢关键事件）。

---

## 5. 交易与订单一致性（生产核心）

- [ ] 幂等键：强制支持并建议使用 `clOrdId/algoClOrdId`；重试/重放不产生重复下单
- [ ] ACK 处理：批量下单/撤单/改单支持部分成功；按每条 `sCode/sMsg` 做结论
- [ ] 订单状态机：orders/fills 推送与 REST 查询一致；可从 REST 做对账补偿（WS 漏消息/重启恢复）
- [ ] “不确定窗口”治理：请求超时后有明确查询确认路径（查订单/查成交/查持仓），禁止盲重试
- [ ] 危险默认值禁止：市价单/数量/杠杆/仓位方向/tdMode 等必须显式；缺省不允许“猜测”

**验收证据建议**：
- 网络超时注入：验证不会重复下单；
- 重启恢复：验证状态可对账闭环（至少订单与持仓不分叉）。

---

## 6. 精度与交易所规则（精度灾难高发区）

- [ ] 金额/数量/价格全链路禁用 `float32/float64`（入参、模型、序列化、日志、计算）
- [ ] tickSize/lotSize/最小下单/最小名义价值：有明确裁剪与舍入方向（并有测试覆盖）
- [ ] 合约单位换算严格：张数/币数/面值（`ctVal/ctMult` 等）不混用；换算可测试
- [ ] 资金字段统一为无损表示（string/定点/decimal），且有统一工具函数/规范

---

## 7. 限频与流控（避免 429 风暴）

- [ ] 全局节流：不仅“单请求退避”，还要有全局并发/速率闸门（按账户/endpoint/方法维度）
- [ ] 自适应：可读取账户限频信息并动态调整（至少不与限频对抗）
- [ ] 策略一致：REST 重试与 WS 重连/重订阅均带 jitter，避免羊群效应

---

## 8. 可观测性（出了事能定位）

- [ ] 结构化日志：最小必要字段（endpoint、method、latency、code、request-id、retry 次数、ws reconnect 次数）
- [ ] 指标：429 计数、重试计数、WS 重连次数、订阅成功率、handler 队列堆积/阻塞、深度断档次数
- [ ] 告警阈值：P99 延迟、连续重连、连续限频、订单/持仓对账失败有明确告警策略

---

## 9. 灾难演练与运行手册（不演练=不生产）

- [ ] 网络抖动/断网：自动恢复；恢复后数据不分叉（对账通过）
- [ ] 时钟漂移：可识别并自愈（重新 sync）；不产生大面积签名失败
- [ ] 限频压测：不会形成重试风暴；具备降级/熔断策略
- [ ] 进程重启：可恢复订阅与状态（WS + REST 补偿闭环）
- [ ] Runbook：故障处置手册覆盖“限频、鉴权失败、WS 重连震荡、深度断档、对账失败”（见 [`runbook.md`](runbook.md)）

---

## 10. 发布判定（Go / No-Go）

- Go：所有 **资金红线项**（第 2/5/6）全通过；关键链路（第 3/4）无已知高风险缺口；演练（第 9）完成并留存证据。
- No-Go：存在任何“密钥泄露/重复下单风险/WS 静默失订阅/深度断档不可检测/无超时边界”等问题。
